# Fastfile para build e distribui√ß√£o do app Android via Firebase App Distribution
# Documenta√ß√£o: https://docs.fastlane.tools

default_platform(:android)

platform :android do

  # ============================================
  # CONFIGURA√á√ïES
  # ============================================
  
  # ID do app no Firebase (configurado via google-services.json)
  # Project: rn---liveness-3d
  FIREBASE_APP_ID = ENV["FIREBASE_APP_ID"] || "1:860321540122:android:0c70d3afd3d6e520b4c9a3"
  
  # Grupos de testers no Firebase App Distribution
  FIREBASE_TESTERS_GROUP = ENV["FIREBASE_TESTERS_GROUP"] || "testers"

  # ============================================
  # LANES PRIVADAS (helpers)
  # ============================================

  desc "Incrementa o version code automaticamente"
  private_lane :increment_version do
    # L√™ o arquivo build.gradle e incrementa versionCode
    path = "../app/build.gradle"
    re = /versionCode\s+(\d+)/
    
    s = File.read(path)
    versionCode = s[re, 1].to_i
    s[re, 1] = (versionCode + 1).to_s
    
    File.write(path, s)
    
    UI.success("Version Code incrementado para: #{versionCode + 1}")
    versionCode + 1
  end

  # ============================================
  # LANES DE BUILD
  # ============================================

  desc "Build APK de Debug"
  lane :build_debug do
    gradle(
      task: "clean assembleDebug",
      project_dir: "./"
    )
    
    UI.success("‚úÖ APK Debug gerado com sucesso!")
    lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
  end

  desc "Build APK de Release"
  lane :build_release do
    gradle(
      task: "clean assembleRelease",
      project_dir: "./"
    )
    
    UI.success("‚úÖ APK Release gerado com sucesso!")
    lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
  end

  desc "Build AAB (Android App Bundle) de Release"
  lane :build_bundle do
    gradle(
      task: "clean bundleRelease",
      project_dir: "./"
    )
    
    UI.success("‚úÖ AAB Release gerado com sucesso!")
    lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]
  end

  # ============================================
  # LANES DE DISTRIBUI√á√ÉO
  # ============================================

  desc "Distribui APK Debug para Firebase App Distribution"
  lane :distribute_debug do |options|
    build_debug
    
    release_notes = options[:notes] || changelog_from_git_commits(
      commits_count: 10,
      pretty: "- %s",
      merge_commit_filtering: "exclude_merges"
    )
    
    # Configura√ß√£o flex√≠vel: groups, testers ou nenhum (apenas upload)
    distribution_config = {
      app: FIREBASE_APP_ID,
      apk_path: lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH],
      release_notes: release_notes,
      firebase_cli_token: ENV["FIREBASE_TOKEN"]
    }
    
    # Adiciona grupos se especificado
    if options[:groups]
      distribution_config[:groups] = options[:groups]
    elsif ENV["FIREBASE_TESTERS_GROUP"] && !ENV["FIREBASE_TESTERS_GROUP"].empty?
      distribution_config[:groups] = ENV["FIREBASE_TESTERS_GROUP"]
    end
    
    # Adiciona testers individuais se especificado
    if options[:testers]
      distribution_config[:testers] = options[:testers]
    elsif ENV["FIREBASE_TESTERS"] && !ENV["FIREBASE_TESTERS"].empty?
      distribution_config[:testers] = ENV["FIREBASE_TESTERS"]
    end
    
    firebase_app_distribution(distribution_config)
    
    UI.success("üöÄ APK Debug enviado com sucesso para Firebase App Distribution!")
  end

  desc "Distribui APK Release para Firebase App Distribution"
  lane :distribute_release do |options|
    build_release
    
    release_notes = options[:notes] || changelog_from_git_commits(
      commits_count: 10,
      pretty: "- %s",
      merge_commit_filtering: "exclude_merges"
    )
    
    # Configura√ß√£o flex√≠vel: groups, testers ou nenhum (apenas upload)
    distribution_config = {
      app: FIREBASE_APP_ID,
      apk_path: lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH],
      release_notes: release_notes,
      firebase_cli_token: ENV["FIREBASE_TOKEN"]
    }
    
    # Adiciona grupos se especificado
    if options[:groups]
      distribution_config[:groups] = options[:groups]
    elsif ENV["FIREBASE_TESTERS_GROUP"] && !ENV["FIREBASE_TESTERS_GROUP"].empty?
      distribution_config[:groups] = ENV["FIREBASE_TESTERS_GROUP"]
    end
    
    # Adiciona testers individuais se especificado
    if options[:testers]
      distribution_config[:testers] = options[:testers]
    elsif ENV["FIREBASE_TESTERS"] && !ENV["FIREBASE_TESTERS"].empty?
      distribution_config[:testers] = ENV["FIREBASE_TESTERS"]
    end
    
    firebase_app_distribution(distribution_config)
    
    UI.success("üöÄ APK Release enviado com sucesso para Firebase App Distribution!")
  end

  desc "Build e distribui com vers√£o incrementada"
  lane :distribute_new_version do |options|
    increment_version
    
    if options[:debug]
      distribute_debug(options)
    else
      distribute_release(options)
    end
  end

  # ============================================
  # LANE PRINCIPAL
  # ============================================

  desc "Lane padr√£o - Build e distribui Release para Firebase"
  lane :deploy do |options|
    distribute_release(options)
  end

  # ============================================
  # LANES DE TESTES
  # ============================================

  desc "Executa testes unit√°rios"
  lane :test do
    gradle(
      task: "test",
      project_dir: "./"
    )
  end

  desc "Executa lint check"
  lane :lint do
    gradle(
      task: "lint",
      project_dir: "./"
    )
  end

  # ============================================
  # CALLBACKS
  # ============================================

  error do |lane, exception|
    UI.error("‚ùå Erro na lane '#{lane}': #{exception.message}")
  end

end


